!function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);class i{constructor(e=0,t=0){this.x=e,this.y=t}copy(){return new i(this.x,this.y)}zero(){this.x=0,this.y=0}rotate(e){const t=this.x*Math.cos(e)-this.y*Math.sin(e),s=this.x*Math.sin(e)+this.y*Math.cos(e);return this.x=t,this.y=s,this}add(e){return this.x+=e.x,this.y+=e.y,this}quantify(){this.x=Math.round(this.x),this.y=Math.round(this.y)}normalize(){const e=Math.sqrt(this.x*this.x+this.y*this.y);return this.x/=e,this.y/=e,this}mul(e){return this.x*=e,this.y*=e,this}getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)}distanceTo(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))}directionTo(e){return Math.PI-Math.atan2(this.x-e.x,this.y-e.y)}angle(){return Math.PI-Math.atan2(-this.x,-this.y)}}const n=20,o=9,a={stone:{x:0,y:0,w:20,h:20},wood:{x:0,y:40,w:20,h:20},tiles:{x:40,y:40,w:20,h:20},carpetBorder:{x:60,y:22,w:20,h:3},carpet:{x:60,y:25,w:20,h:20},tableBorder:{x:60,y:45,w:20,h:2},table:{x:60,y:47,w:47,h:20},wall:{x:0,y:20,w:20,h:20},body:{x:20,y:0,w:17,h:10},armsFisting:{x:20,y:10,w:16,h:12},armsFree:{x:34,y:60,w:16,h:6},armsGrabbing:{x:34,y:66,w:16,h:9},corpse:{x:42,y:0,w:35,h:21},door:{x:20,y:40,w:20,h:20},light:{x:20,y:30,w:5,h:10},lightBroken:{x:25,y:30,w:5,h:10},chair:{x:41,y:22,w:19,h:16},hidden:{x:30,y:24,w:9,h:4},visible:{x:30,y:28,w:9,h:5},reload:{x:30,y:33,w:7,h:4},pickablePistol:{x:0,y:60,w:16,h:7},pickableMG:{x:0,y:67,w:16,h:7},pickableMinigun:{x:0,y:73,w:16,h:7},gunPistol:{x:16,y:60,w:6,h:15},gunMG:{x:22,y:60,w:6,h:15},gunMinigun:{x:28,y:60,w:6,h:15}},r={shootPistol:{biquadType:"lowpass",biquadQ:1,frequency:1e3,gainParams:[0,0,1,.001,.3,.101,0,.5],volume:1},shootMG:{biquadType:"lowpass",biquadQ:1,frequency:1300,gainParams:[0,0,1,.001,.3,.101,0,.5],volume:.9},shootMinigun:{biquadType:"lowpass",biquadQ:5,frequency:1700,gainParams:[0,0,1,.001,.3,.101,0,.4],volume:.2},collectA:{biquadType:"bandpass",biquadQ:1,frequency:4500,gainParams:[0,0,0,.001,.5,.1,0,.4],volume:.6},collectB:{biquadType:"lowpass",biquadQ:1,frequency:1500,gainParams:[0,0,0,.1,.5,.3,0,.4],volume:.6},fist:{biquadType:"bandpass",biquadQ:1,frequency:8500,gainParams:[0,0,0,.001,.5,.1,0,.2],volume:.1},fistHitA:{biquadType:"bandpass",biquadQ:1,frequency:300,gainParams:[0,0,0,.001,.5,.1,0,.2],volume:.9},fistHitB:{biquadType:"lowpass",biquadQ:1,frequency:500,gainParams:[0,0,0,.1,.5,.2,0,.25],volume:.9},noAmmoA:{biquadType:"bandpass",biquadQ:1,frequency:1200,gainParams:[0,0,0,.001,.5,.04,0,.12],volume:.6},noAmmoB:{biquadType:"lowpass",biquadQ:1,frequency:7e3,gainParams:[0,0,0,.1,.5,.08,0,.12],volume:.6}};function h(e,t){const s={biquadType:"lowpass",biquadQ:1,frequency:300,gainParams:[0,0,1,.001,.3,.101,0,.2],volume:.25};Object.assign(s,t);let i=Object.assign({},s);i.gainParams=i.gainParams.map(e=>1.5*e),r[`${e}Run0`]=i,r[`${e}Run1`]=Object.assign(i,{frequency:i.frequency+100}),(i=Object.assign({},s)).volume*=.6,i.gainParams=i.gainParams.map(e=>.8*e),r[`${e}Walk0`]=i,r[`${e}Walk1`]=Object.assign(i,{frequency:i.frequency+100})}h("stone",{}),h("wood",{frequency:550,gainParams:[0,0,1,.001,.3,.151,0,.2],volume:.2}),h("carpet",{frequency:100,gainParams:[0,0,1,.001,.3,.151,0,.2],volume:.15}),h("tiles",{frequency:450,gainParams:[0,0,1,.001,.2,.151,0,.2],volume:.15});const l=5;class c{constructor(e){for(var t=5*e.sampleRate,s=e.createBuffer(1,t,e.sampleRate),i=s.getChannelData(0),n=0;n<t;n++)i[n]=2*Math.random()-1;this.node=e.createBufferSource(),this.node.buffer=s,this.node.loop=!0,this.node.start()}connect(e){this.node.connect(e)}}class d{constructor(e,t){this.context=e,this.gainParams=t,this.node=e.createGain(),this.node.gain.value=0}addEventToQueue(){for(let e=0;e<this.gainParams.length;e+=2)this.node.gain.linearRampToValueAtTime(this.gainParams[e],this.context.currentTime+this.gainParams[e+1])}connect(e){this.node.connect(e)}}class g{constructor(e,t){this.context=e,this.params=t,this.voices=[],this.voiceIndex=0,this.noise=new c(this.context),this.makeSample()}play(){this.voiceIndex=(this.voiceIndex+1)%l,this.voices[this.voiceIndex].addEventToQueue()}makeSample(){const e=this.context.createBiquadFilter();e.type=this.params.biquadType,e.Q.value=this.params.biquadQ,e.frequency.value=this.params.frequency;for(var t=0;t<l;t++){var s=new d(this.context,this.params.gainParams);this.noise.connect(s.node),s.connect(e),this.voices.push(s)}this.masterNode=this.context.createGain(),this.masterNode.gain.value=this.params.volume,e.connect(this.masterNode),this.masterNode.connect(this.context.destination)}}class p{constructor(){this.context=new AudioContext,this.samples={};for(const[e,t]of Object.entries(r))this.samples[e]=new g(this.context,t)}play(e){this.samples[e].play()}}class u{constructor(e){this.game=e,this.systemsMap=new Map,this.systems=[],this.sound=new p}getSystem(e){return this.systemsMap.get(e)}register(e){this.systems.push(e),this.systemsMap.set(e.constructor,e),e.engine=this}init(){for(const e of this.systems)e.init()}update(e){this.time+=e;for(const e of this.systems)e.update()}clear(){this.time=0,this.systems=[],this.systemsMap.clear()}}class m{constructor(){this.entities=[]}init(){}add(e){e.system=this,this.entities.push(e)}remove(e){const t=this.entities.indexOf(e);-1!==t&&this.entities.splice(t,1)}clear(){this.entities=[]}start(){}end(){}}class y{getTopParent(){let e=this;for(;e.parent;)e=this.parent;return e}*getAncestors(){let e=this;for(yield e;e.parent;)yield e=this.parent}destroy(){this.system.remove(this)}}class f extends y{constructor(e,t,s=1){super(),this.pos=t,this.friction=s,this.vel=new i,e.getSystem(x).add(this),this.floatPos=t.copy()}}class x extends m{update(){for(const e of this.entities)e.floatPos.add(e.vel),e.pos.x=Math.round(e.floatPos.x),e.pos.y=Math.round(e.floatPos.y),e.vel.x/=e.friction,e.vel.y/=e.friction}}const w=1,v=2,b=4,M=8,S=w|b,T=w|v,P=v|b;var A;!function(e){e[e.gridCell=0]="gridCell",e[e.point=1]="point",e[e.circle=2]="circle"}(A||(A={}));class k extends m{constructor(){super(...arguments),this.staticGrid=new Map,this.dynamicGrid=new Map,this.dynamicReceivers=[],this.listeners=new Map}makeCollidable(e){return e.mask&P?(this.dynamicReceivers.push(e),this.putToGrid(this.dynamicGrid,e)):(e.mask&w||e.mask&M)&&this.putToGrid(this.staticGrid,e),e.canHit&&this.entities.push(e),e}remove(e){if(super.remove(e),e.mask&P){const t=this.dynamicReceivers.indexOf(e);-1!==t&&this.dynamicReceivers.splice(t,1)}else if(e.mask&w||e.mask&M){const t=this.getIndexOfPos(e.pos),s=this.staticGrid.get(t);if(s){const i=s.indexOf(e);-1!==i&&(s.splice(i,1),0===s.length&&this.staticGrid.delete(t))}}}clear(){super.clear(),this.staticGrid.clear(),this.dynamicGrid.clear(),this.dynamicReceivers=[]}update(){this.dynamicGrid.clear();for(const e of this.dynamicReceivers)this.putToGrid(this.dynamicGrid,e);const e=this.broadPhase();this.narrowPhase(e)}broadPhase(){const e=[];for(const t of this.entities)for(const s of this.getCellsOf(t)){if(this.staticGrid.has(s))for(const e of this.staticGrid.get(s))e.mask&t.canHit&&this.onColision(t,e);if(t.canHit&P&&this.dynamicGrid.has(s))for(const i of this.dynamicGrid.get(s))i!==t&&i.mask&t.canHit&&e.push([t,i])}return e}narrowPhase(e){for(const[t,s]of e)this.checkColisions(t,s)}checkColisions(e,t){e.pos.distanceTo(t.pos)<t.radius&&this.onColision(e,t)}onColision(e,t){e.shouldDecouple&&this.decouple(e),this.emitColision(e,t)}decouple(e){const t=e.parent.posAndVel.floatPos,s=e.parent.posAndVel.vel,o=t.copy();this.snapToGrid(t,e);this.getIndexOfCell(Math.floor(t.x/n),Math.floor(t.y/n));const a=s.x>0?1:-1,r=o.x+s.x+e.radius*a,h=this.getIndexOfPos(new i(r,t.y));this.staticGrid.has(h)?s.x=0:t.x=o.x;const l=s.y>0?1:-1,c=o.y+s.y+e.radius*l,d=this.getIndexOfPos(new i(t.x,c));this.staticGrid.has(d)?s.y=0:t.y=o.y,e.parent.posAndVel.pos.x=Math.round(e.parent.posAndVel.floatPos.x),e.parent.posAndVel.pos.y=Math.round(e.parent.posAndVel.floatPos.y)}snapToGrid(e,t){e.x=Math.floor(e.x/n)*n+n/2,e.y=Math.floor(e.y/n)*n+n/2}listenColisions(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}putToGrid(e,t){if(t.shape===A.circle)for(const s of this.getCellsOf(t))this.addToGrid(e,s,t);else{const s=this.getIndexOfCell(Math.floor(t.pos.x/n),Math.floor(t.pos.y/n));this.addToGrid(e,s,t)}}addToGrid(e,t,s){e.has(t)?e.get(t).push(s):e.set(t,[s])}*getCellsOf(e){if(e.shape!==A.point){const t=Math.floor((e.pos.x-e.radius)/n),s=Math.floor((e.pos.x+e.radius-1)/n),i=Math.floor((e.pos.y-e.radius)/n),o=Math.floor((e.pos.y+e.radius-1)/n);for(let e=t;e<=s;e++)for(let t=i;t<=o;t++)yield this.getIndexOfCell(e,t)}else yield this.getIndexOfCell(Math.floor(e.pos.x/n),Math.floor(e.pos.y/n))}getIndexOfCell(e,t){return 1e3*e+t}getIndexOfPos(e){return this.getIndexOfCell(Math.floor(e.x/n),Math.floor(e.y/n))}emitColision(e,t){for(const s of e.parent.getAncestors()){const e=s.constructor;if(this.listeners.has(e)){const i={hitter:s,receiver:t.parent};for(const t of this.listeners.get(e))t(i)}}}castRay(e,t){const s=e.distanceTo(t),o=e.copy(),a=Math.floor(s/n*20),r=new i(t.x-e.x,t.y-e.y).mul(1/a);for(let e=0;e<a;e++){o.add(r);const e=this.getIndexOfPos(o);if(this.staticGrid.has(e))for(const t of this.staticGrid.get(e))if(t.mask&w)return o}return null}}class C extends y{constructor(e,t){super(),this.rot=null,this.needRerender=!1,this.changing=!1,this.pivot=new i,this.offset=new i,this.aboveLevel=!1,this.zIndex=0,Object.assign(this,t),e.getSystem(R).add(this)}queueRender(){this.changing||this.system.add(this)}}class R extends m{constructor(){super(...arguments),this.charsToRender=[],this.toRender={},this.higherToRender=[],this.zIndexes=[]}add(e){e.system=this,e.changing?super.add(e):e.aboveLevel?this.higherToRender.push(e):e.text?this.charsToRender.push(e):(this.updateZIndexes(e.zIndex),this.toRender[e.zIndex].push(e))}updateZIndexes(e){this.toRender[e]||(this.toRender[e]=[],this.zIndexes.push(e),this.zIndexes=this.zIndexes.sort())}update(){}}class I extends y{constructor(e,t){super(),this.engine=e,Object.assign(this,t),this.bornAt=this.engine.time;const s=t.pos.copy();this.posAndVel=new f(this.engine,s,t.friction),this.posAndVel.vel=t.vel,this.collidable=this.engine.getSystem(k).makeCollidable({pos:s,shape:A.point,parent:this,canHit:t.canHit}),e.getSystem(O).add(this)}destroy(){this.posAndVel.destroy(),this.engine.getSystem(k).remove(this.collidable),super.destroy(),this.onDeath&&this.onDeath(this.collidable.pos)}}class O extends m{constructor(){super(...arguments),this.byColors={red:[],gray:[],white:[]}}init(){this.engine.getSystem(k).listenColisions(I,e=>{e.hitter.destroy()})}update(){for(const e of this.entities)this.engine.time>e.bornAt+e.lifetime&&e.destroy()}add(e){super.add(e),this.byColors[e.color].push(e)}remove(e){super.remove(e);const t=this.byColors[e.color],s=t.indexOf(e);t.splice(s,1)}emit(e,t){for(let s=0;s<t.count;s++){const s=new I(this.engine,e);s.posAndVel.vel=t.direction.copy().rotate((Math.random()-.5)*t.spread).mul((Math.random()+.5)*t.speedSpread),s.lifetime*=(Math.random()+.5)*t.lifetimeSpread}}}const L=300;class W extends m{constructor(){super(...arguments),this.toRender=[],this.leaks=[],this.leaksToRender=[]}emitBlood(e,t){this.engine.getSystem(O).emit({pos:e,color:"red",lifetime:150,canHitDynamic:!1,canHit:w,onDeath:s=>{const n=new i(0,.6*t.getLength()).rotate(s.directionTo(e));this.toRender.push({from:s,to:s.copy().add(n)})}},{count:Math.ceil(50*Math.random())+5,direction:t.copy().mul(.35),spread:1.2,speedSpread:.8,lifetimeSpread:.9})}leakFromCorpse(e){for(let t=0;t<3;t++){const t=new i(6-12*Math.random(),6-12*Math.random()),s={pos:e.copy().add(t),lastLeak:0,size:0,maxSize:5*Math.random()+3};this.leaks.push(s)}}update(){for(const e of this.leaks)if(this.engine.time-e.lastLeak>L&&(e.lastLeak=this.engine.time,e.size+=1,this.leaksToRender.push(e),e.size>e.maxSize)){const t=this.leaks.indexOf(e);this.leaks.splice(t,1)}}}class V extends y{constructor(e){super(),this.agent=e,e.engine.getSystem(E).add(this)}}class E extends m{update(){}}class B extends y{constructor(e,t){super(),this.engine=e,Object.assign(this,t),this.prop=new C(this.engine,{pos:this.pos,changing:!0,sprite:`pickable${this.gun.options.code}`,pivot:new i(8,3)}),e.getSystem(D).add(this)}destroy(){this.prop.destroy(),super.destroy()}}class D extends m{update(){const e=this.engine.getSystem(U);if(!e.player)return;const t=e.player.agent;for(const e of this.entities)e.prop.rot+=.03,t.posAndVel.pos.distanceTo(e.pos)<10&&(t.weaponsMap.has(e.gun.options.code)||this.engine.game.notifyNewWeapon(e.gun),t.addWeapon(e.gun,.4),e.destroy(),this.engine.sound.play("collectA"),this.engine.sound.play("collectB"))}}class H extends y{constructor(e,t,s){super(),this.engine=e,this.FISTS_COOLDOWN=600,this.isFisting=!1,this.lastFistHit=0,this.maxRunSpeed=3,this.maxWalkSpeed=.5,this.maxSpeed=this.maxRunSpeed,this.weight=1,this.ACCELERATION=.5,this.rot=0,this.weaponsMap=new Map,this.weapons=[],this.weaponIndex=0,this.maxHealth=5,this.isRunning=!0,s&&Object.assign(this,s),this.health=this.maxHealth,this.engine.getSystem(j).add(this),this.posAndVel=new f(this.engine,t,1.3);const i=this.engine.getSystem(k);this.collidable=i.makeCollidable({pos:this.posAndVel.pos,shape:A.circle,radius:n/2,shouldDecouple:!0,parent:this,mask:s.colisionMask,canHit:w|M})}destroy(){this.engine.getSystem(W).leakFromCorpse(this.posAndVel.pos),new C(this.engine,{sprite:"corpse",pos:this.posAndVel.pos,rot:Math.random()*Math.PI*2,aboveLevel:!0,pivot:new i(20,10)}),this.engine.getSystem(k).remove(this.collidable),this.posAndVel.destroy(),this.flashlight&&this.flashlight.destroy(),this.currentWeapon&&new B(this.engine,{pos:this.posAndVel.pos.copy(),gun:this.currentWeapon}),super.destroy()}moveToDirection(e){const t=new i(0,this.ACCELERATION).rotate(e);this.updateVelocity(t)}shoot(){return this.currentWeapon?this.currentWeapon.shoot():this.hitWithFists()}decreaseHealth(){this.health--,this.health<=0&&this.getTopParent().destroy(),this.onHit&&this.onHit()}updateVelocity(e){const t=this.maxSpeed/this.weight;this.posAndVel.vel.x=Math.min(t,Math.max(-t,this.posAndVel.vel.x+e.x)),this.posAndVel.vel.y=Math.min(t,Math.max(-t,this.posAndVel.vel.y+e.y))}toggleFlashlight(){this.flashlight?(this.flashlight.destroy(),this.flashlight=null):this.flashlight=new V(this)}toggleWalkRun(){this.isRunning?this.walk():this.run()}run(){this.maxSpeed=this.maxRunSpeed,this.isRunning=!0}walk(){this.maxSpeed=this.maxWalkSpeed,this.isRunning=!1}addWeapon(e,t=1){const s=Math.round(e.totalBullets*t);if(this.weaponsMap.has(e.options.code)){this.weaponsMap.get(e.options.code).totalBullets+=s}else{this.weaponsMap.set(e.options.code,e),this.weapons.push(e),e.setOwner(this),e.totalBullets=s,e.bulletsInMagazine=Math.min(e.bulletsInMagazine,e.totalBullets);const t=this.currentWeapon?this.currentWeapon.options.priority:0;e.options.priority>t&&(this.setWeapon(e),this.weaponIndex=this.weapons.length-1)}}nextWeapon(){this.weapons.length&&(this.weaponIndex++,this.weaponIndex>=this.weapons.length?(this.weaponIndex=-1,this.setWeapon(null)):this.setWeapon(this.weapons[this.weaponIndex]))}setWeapon(e){this.currentWeapon=e,this.weight=e?e.options.weight:1}hitWithFists(){if(this.engine.time-this.lastFistHit>this.FISTS_COOLDOWN){this.lastFistHit=this.engine.time,this.isFisting=!0,setTimeout(()=>this.isFisting=!1,300),this.engine.sound.play("fist");const e=this.posAndVel.pos;for(const t of this.system.entities){if(e.distanceTo(t.posAndVel.pos)>25)continue;if(this.collidable.mask===t.collidable.mask)continue;const s=this.rot>0?this.rot:2*Math.PI+this.rot,n=Math.abs(e.directionTo(t.posAndVel.pos)-s);if(n<1||n>5){t.decreaseHealth(),this.engine.sound.play("fistHitA"),this.engine.sound.play("fistHitB"),this.engine.getSystem(W).emitBlood(t.posAndVel.pos,new i(5*(Math.random()-.5),5*(Math.random()-.5)))}}}}}class j extends m{update(){}}const q="difficulty",G={easy:{name:"easy",playerHealthMultiplier:2,enemyHealthMultiplier:.4,visibilityLevel:90,aiReactionTime:700},normal:{name:"normal",playerHealthMultiplier:1.2,enemyHealthMultiplier:.8,visibilityLevel:60,aiReactionTime:500},hard:{name:"hard",playerHealthMultiplier:.9,enemyHealthMultiplier:1.2,visibilityLevel:40,aiReactionTime:300}};let F=G[localStorage.getItem(q)||"easy"];const z={".":"stone","-":"wood",";":"carpet","+":"tiles"},_=350,N=700;class $ extends y{constructor(e,t){super(),this.engine=e,this.lastVisibilityUpdateTime=0,this.lastNoiseTime=0,this.isNoisy=!1,this.agent=new H(this.engine,t,{maxHealth:30*F.playerHealthMultiplier,colisionMask:v}),this.agent.parent=this,this.agent.maxWalkSpeed=1,e.getSystem(U).add(this)}destroy(){super.destroy(),this.agent.destroy()}makeNoise(){this.isNoisy=!0,this.lastNoiseTime=this.engine.time}get isVisible(){return this.visibility>F.visibilityLevel||!!this.agent.flashlight}}class U extends m{constructor(){super(),this.STEPS_RATE=270,this.currentStep=0,this.lastStepTime=0,this.weaponIndex=0}add(e){super.add(e),this.player=e}remove(e){super.remove(e),this.player=null,this.engine.game.isPlayerDead=!0}update(){for(const e of this.entities)this.engine.time-e.lastNoiseTime>N&&(e.isNoisy=!1),e.agent.rot=this.engine.game.control.rot,this.updateControls(e),this.updateVisibility(e),this.makeStep(e)}updateVisibility(e){const t=this.engine.game.renderer.compositor.layers.combinedLights,s=t.canvas;this.engine.time-e.lastVisibilityUpdateTime>_&&(e.visibility=t.context.getImageData(s.width/2,s.height/2,1,1).data[0],e.lastVisibilityUpdateTime=this.engine.time)}updateControls(e){const t=this.engine.game.control;if(t.keys.get("KeyW")&&e.agent.moveToDirection(Math.PI),t.keys.get("KeyA")&&e.agent.moveToDirection(.5*Math.PI),t.keys.get("KeyS")&&e.agent.moveToDirection(0),t.keys.get("KeyD")&&e.agent.moveToDirection(1.5*Math.PI),t.mouseButtons.get(0)||t.keys.get("Space")){e.agent.shoot()&&e.makeNoise()}}makeStep(e){const t=e.agent,s=Math.max(1,t.weight/2),i=this.STEPS_RATE*s*(t.isRunning?1:1.6);if(this.engine.time-this.lastStepTime>i&&e.agent.posAndVel.vel.getLength()>.5){this.lastStepTime=this.engine.time,this.currentStep=(this.currentStep+1)%2;const t=e.agent.posAndVel.pos,s=Math.floor(t.x/n),i=Math.floor(t.y/n),o=this.engine.level[i][s],a=`${z[o]||"stone"}${e.agent.isRunning?"Run":"Walk"}${this.currentStep.toString()}`;this.engine.sound.play(a),e.agent.isRunning&&e.makeNoise()}}}class X extends y{constructor(e,t){super(),this.engine=e,this.sprite="wall",this.colisionMask=w,Object.assign(this,t),this.collidable=this.engine.getSystem(k).makeCollidable({pos:this.pos,shape:A.gridCell,parent:this,mask:this.colisionMask}),this.prop=new C(this.engine,{pos:this.pos,sprite:this.sprite,zIndex:t.zIndex||0}),e.getSystem(Q).add(this)}}class Q extends m{update(){}emitDebris(e,t){this.engine.getSystem(O).emit({pos:e.copy(),color:"gray",lifetime:300,canHitDynamic:!1,canHit:0},{count:Math.ceil(25*Math.random()),direction:t.copy().mul(-.3),spread:Math.PI,speedSpread:.5,lifetimeSpread:.5})}}class K extends y{constructor(e,t){super(),Object.assign(this,t),this.pos=this.collidable.pos,this.collidable.shape===A.gridCell&&(this.pos=this.pos.copy().add(new i(n/2,n/2))),e.getSystem(Y).add(this)}trigger(){this.action(this.collidable.parent)}}class Y extends m{update(){const e=this.engine.getSystem(U).player;if(!e)return;const t=e.agent.posAndVel.pos;let s=25,i=0;this.action=null;for(const e of this.entities){const n=t.distanceTo(e.pos);n<s&&e.priority>=i&&(s=n,i=e.priority,this.action=e)}}}const J=0;class Z extends y{constructor(e,t){if(super(),this.engine=e,this.physical=!1,this.enabled=!0,this.broken=!1,this.lastUpdated=0,this.radius=250,this.power="white",this.direction=new i,Object.assign(this,t),this.physical){let e=0;"up"===this.wallDirection?(e=Math.PI/2,this.pos.add(new i(n/2,0)),this.direction=new i(0,1)):"right"===this.wallDirection?(e=Math.PI,this.pos.add(new i(n,n/2)),this.direction=new i(-1,0)):"down"===this.wallDirection?(e=-Math.PI/2,this.pos.add(new i(n/2,n)),this.direction=new i(0,-1)):"left"===this.wallDirection&&(this.pos.add(new i(0,n/2)),this.direction=new i(1,0)),this.collidable=this.engine.getSystem(k).makeCollidable({pos:this.pos,shape:A.circle,radius:5,parent:this,mask:P}),this.prop=new C(this.engine,{pos:this.pos,sprite:"light",aboveLevel:!0,pivot:new i(0,5),rot:e}),this.broken||(this.action=new K(this.engine,{collidable:this.collidable,text:"toggle",priority:1,action:()=>this.toggle()}))}e.getSystem(ee).add(this)}broke(){this.enabled&&!this.broken&&(this.action.destroy(),this.action=null,Math.random()>.7&&(this.broken=!0,this.radius/=2,this.power="#aaa"),this.toggle(),this.emitSparks(2))}toggle(){this.system.needRerender=!0,this.enabled=!this.enabled,this.lastUpdated=this.engine.time,this.prop.sprite=this.enabled?"light":"lightBroken",this.prop.queueRender(),this.broken&&this.direction&&this.emitSparks()}emitSparks(e=1){this.engine.getSystem(O).emit({pos:this.pos.copy(),color:"white",lifetime:400,canHitDynamic:!1,canHit:0,friction:1.1},{count:Math.ceil(10*Math.random()*e),direction:this.direction.copy().mul(5*e),spread:Math.PI,speedSpread:.5,lifetimeSpread:.5})}}class ee extends m{constructor(){super(...arguments),this.needRerender=!0}add(e){super.add(e),this.needRerender=!0}remove(e){super.remove(e),this.needRerender=!0}update(){for(const e of this.entities)e.broken&&this.engine.time-e.lastUpdated>J&&Math.random()>.9&&e.toggle()}}class te extends y{constructor(e,t,s,i,n){super(),this.engine=e,this.maxLifetime=i,this.particle=new I(this.engine,{pos:t,vel:s,color:"red",lifetime:i,canHitDynamic:!0,canHit:n}),this.particle.parent=this}destroy(){super.destroy(),this.particle.destroy()}}class se extends m{init(){const e=this.engine.getSystem(k),t=this.engine.getSystem(W),s=this.engine.getSystem(Q);e.listenColisions(te,e=>{e.receiver instanceof H?(e.receiver.decreaseHealth(),t.emitBlood(e.hitter.particle.posAndVel.pos,e.hitter.particle.posAndVel.vel)):e.receiver instanceof X?s.emitDebris(e.hitter.particle.posAndVel.pos,e.hitter.particle.posAndVel.vel):e.receiver instanceof Z&&e.receiver.broke()})}makeProjectile(e,t,s,i){this.add(new te(this.engine,e,t,s,i))}update(){}}const ie={pistol:{code:"Pistol",name:"Pistol",magazineCapacity:6,reloadTime:2e3,shootSpeed:250,bulletSpeed:6,bulletLifetime:1e4,spread:0,defaultAmmo:36,priority:1,weight:1},mg:{code:"MG",name:"Machine gun",magazineCapacity:30,reloadTime:3e3,shootSpeed:80,bulletSpeed:8,bulletLifetime:15e3,spread:Math.PI/20,defaultAmmo:120,priority:2,weight:1},minigun:{code:"Minigun",name:"Minigun",magazineCapacity:500,reloadTime:5e3,shootSpeed:20,bulletSpeed:10,bulletLifetime:15e3,spread:Math.PI/15,defaultAmmo:500,priority:3,weight:2.5}};class ne{constructor(e,t){this.engine=e,this.options=t,this.lastShootTime=0,this.reloading=!1,this.totalBullets=t.defaultAmmo,this.bulletsInMagazine=this.options.magazineCapacity,this.projectileSystem=e.getSystem(se)}shoot(){if(this.engine.time-this.lastShootTime<this.options.shootSpeed)return!1;if(0===this.bulletsInMagazine)return this.lastShootTime=this.engine.time,this.engine.sound.play("noAmmoA"),this.engine.sound.play("noAmmoB"),!1;const e=this.owner.rot+(Math.random()-.5)*this.options.spread,t=new i(0,11).rotate(this.owner.rot),s=new i(0,this.options.bulletSpeed).rotate(e);return this.projectileSystem.makeProjectile(this.owner.posAndVel.pos.copy().add(t),s,this.options.bulletLifetime,this.canHit),this.bulletsInMagazine--,this.totalBullets--,this.lastShootTime=this.engine.time,this.makeLight(),this.engine.sound.play("shoot"+this.options.code),0===this.bulletsInMagazine&&this.reload(),!0}reload(){this.reloading=!0,setTimeout(()=>{this.bulletsInMagazine=Math.min(this.options.magazineCapacity,this.totalBullets),this.reloading=!1},this.options.reloadTime)}setOwner(e){const t=e.parent instanceof $;this.canHit=t?S:T,this.owner=e}makeLight(){const e=new i(0,16).rotate(this.owner.rot),t=this.owner.posAndVel.pos.copy().add(e),s=new Z(this.engine,{pos:t,enabled:!0,radius:60});setTimeout(()=>s.destroy())}}const oe=7e3,ae=1500,re=3e3;var he,le;!function(e){e[e.idle=0]="idle",e[e.patroling=1]="patroling",e[e.alerted=2]="alerted",e[e.chasing=3]="chasing",e[e.fighting=4]="fighting"}(he||(he={}));class ce extends y{constructor(e,t){super(),this.engine=e,this.lastThinking=this.engine.time+F.aiReactionTime*Math.random(),this.lastRotChange=0,this.rotTarget=0,this.rotSpeed=2,this.canPatrol=!1,this.playerInRange=!1,this.seePlayer=!1,this.hearPlayer=!1,this.isShooting=!1,this.pointsVisitCount=new Map,this.canBeAssasinated=!0,this.superAggresive=!1,Object.assign(this,t),this.agent=new H(e,t.pos,{colisionMask:b,maxHealth:(t.maxHealth||5)*F.enemyHealthMultiplier}),this.agent.parent=this,this.agent.onHit=(()=>this.state=he.alerted),t.weapon&&this.agent.addWeapon(new ne(this.engine,ie[t.weapon])),this.canPatrol&&this.agent.toggleFlashlight(),this.goIdle(),e.getSystem(de).add(this)}destroy(){super.destroy(),this.agent.destroy(),this.destroyAction()}shootAt(e){this.agent.rot=this.agent.posAndVel.pos.directionTo(e);const t=this.agent.currentWeapon;t&&t.reloading||this.agent.shoot()}shootAtPlayer(){const e=this.agent.currentWeapon;e&&0===e.totalBullets&&(this.agent.currentWeapon=null);const t=this.agent.posAndVel,s=this.playerPos.copy(),i=t.pos.distanceTo(this.playerPos);if(e){const t=i/e.options.bulletSpeed;s.add(this.playerVel.copy().mul(t)),this.shootAt(s)}else i>25?this.moveTarget=s:this.shootAt(s)}think(e){e&&this.playerInRange&&(this.playerPos=e.pos.copy(),this.playerVel=e.vel.copy());const t=this.engine.getSystem(U).player.isVisible;switch(this.isShooting=this.seePlayer&&t,this.state){case he.idle:this.whenIdle();break;case he.patroling:this.whenPatroling();break;case he.fighting:this.whenFighting();break;case he.chasing:this.whenChasing();break;case he.alerted:this.whenAlerted()}}whenIdle(){this.engine.time-this.lastRotChange>re&&(this.rotTarget=Math.random()*Math.PI*2,this.lastRotChange=this.engine.time),this.seePlayer||this.hearPlayer?(this.goFighting(),this.moveTarget=null,this.destroyAction(),this.notifyNeighbours(this.playerPos)):this.canPatrol&&(this.state=he.patroling,this.agent.walk())}whenPatroling(){if(this.whenIdle(),!this.moveTarget){const e=this.system.getVisiblePatrolPoints(this.agentPos);if(!e.length)return;let t=Number.MAX_SAFE_INTEGER,s=[];for(const i of e){const e=this.pointsVisitCount.get(i)||0;e<t&&(t=e,s=[]),e===t&&s.push(i)}let i=1e3;for(const e of s){const t=e.distanceTo(this.agentPos);t<i&&(i=t,this.moveTarget=e)}if(this.moveTarget){const e=this.pointsVisitCount.get(this.moveTarget)||0;this.pointsVisitCount.set(this.moveTarget,e+1)}}this.moveTarget&&(this.rotTarget=this.agentPos.directionTo(this.moveTarget))}whenFighting(){this.agent.run(),this.playerInRange?this.isShooting=!0:this.goChasing()}whenChasing(){this.playerInRange?this.goFighting():this.moveTarget||this.goAlerted()}whenAlerted(){if(this.rotTarget=Math.random()*Math.PI*2,(this.seePlayer||this.hearPlayer)&&this.goFighting(),this.engine.time-this.alertedAt>oe&&this.goIdle(),this.engine.time-this.changedTargetAt>ae){const e=new i(200*(.5-Math.random()),200*(.5-Math.random()));this.moveTarget=e.add(this.agentPos),this.changedTargetAt=this.engine.time}}goAlerted(){this.state=he.alerted,this.rotSpeed=.1,this.alertedAt=this.engine.time,this.changedTargetAt=this.engine.time,this.destroyAction()}goIdle(){this.state=he.idle,this.rotSpeed=.02,this.canBeAssasinated&&(this.action=new K(this.engine,{collidable:this.agent.collidable,text:"kill",priority:9,action:()=>this.destroy()}))}goFighting(){this.superAggresive?this.goChasing():this.state=he.fighting,this.rotSpeed=.1}goChasing(){this.state=he.chasing,this.moveTarget=this.playerPos}notifyNeighbours(e){for(const t of this.system.entities)if(t.state===he.idle||t.state===he.patroling){this.agentPos.distanceTo(t.pos)<80&&(t.goAlerted(),t.moveTarget=e)}}destroyAction(){this.action&&(this.action.destroy(),this.action=null)}get agentPos(){return this.agent.posAndVel.pos}}class de extends m{constructor(){super(...arguments),this.patrolPoints=[]}init(){this.playerSystem=this.engine.getSystem(U),this.colisionSystem=this.engine.getSystem(k)}update(){if(this.playerSystem.player)for(const e of this.entities){if(this.engine.time-e.lastThinking>F.aiReactionTime&&(this.process(e),e.lastThinking=this.engine.time),e.isShooting&&(e.playerPos=this.playerPosAndVel.pos,e.shootAtPlayer()),e.moveTarget){const t=e.agent.posAndVel.pos.directionTo(e.moveTarget);e.agent.moveToDirection(t),e.agent.posAndVel.pos.distanceTo(e.moveTarget)<20&&(e.moveTarget=null)}if(e.rotTarget!==e.agent.rot){const t=e.rotTarget-e.agent.rot,s=Math.abs(t)>Math.PI?-1:1,i=e.rotTarget>e.agent.rot?1:-1;e.agent.rot+=e.rotSpeed*s*i,e.agent.rot>=2*Math.PI?e.agent.rot-=2*Math.PI:e.agent.rot<0&&(e.agent.rot+=2*Math.PI),Math.abs(e.agent.rot-e.rotTarget)<.05&&(e.agent.rot=e.rotTarget)}}}process(e){let t;if(e.playerInRange=this.isPlayerInRange(e),e.hearPlayer=e.playerInRange&&this.player.isNoisy,e.playerInRange){const s=e.agent.posAndVel.pos,i=this.playerPosAndVel.pos,n=s.directionTo(i);t=Math.min(2*Math.PI-Math.abs(n-e.agent.rot),Math.abs(n-e.agent.rot))}e.seePlayer=e.playerInRange&&t<1.2&&this.player.isVisible,e.think(this.playerPosAndVel)}isPlayerInRange(e){return!this.colisionSystem.castRay(e.agent.posAndVel.pos,this.playerPosAndVel.pos)}get player(){return this.playerSystem.player}get playerPosAndVel(){return this.player?this.player.agent.posAndVel:null}addPatrolPoint(e){this.patrolPoints.push(e)}getVisiblePatrolPoints(e){return this.patrolPoints.filter(t=>!this.colisionSystem.castRay(e,t))}}!function(e){e[e.vertical=0]="vertical",e[e.horizontal=1]="horizontal"}(le||(le={}));class ge extends y{constructor(e,t){super(),this.engine=e,this.opened=!1,Object.assign(this,t),this.collidable=this.engine.getSystem(k).makeCollidable({pos:this.pos,shape:A.gridCell,parent:this,mask:w});const s=this.orientation===le.horizontal,o=s?0:n/2+1,a=s?n/2+1:0;this.propA=new C(this.engine,{pos:this.pos.copy().add(new i(o,a)),rot:s?0:Math.PI/2,sprite:"door",changing:!0,pivot:new i(0,n/2),offset:s?new i(0,n/2):new i(n/2,0)}),this.propB=new C(this.engine,{pos:this.pos.copy().add(new i(-o,-a)),rot:s?0:Math.PI/2,sprite:"door",changing:!0,pivot:new i(0,n/2),offset:s?new i(0,n/2):new i(n/2,0)}),this.action=new K(this.engine,{collidable:this.collidable,text:"open",priority:5,action:()=>this.open()}),e.getSystem(pe).add(this)}open(){const e=this.engine.getSystem(k);this.propA.pos=this.pos,this.propA.rot+=Math.PI/2,this.propB.destroy(),e.remove(this.collidable),this.action.destroy()}}class pe extends m{update(){}}const ue=".+-;[",me={X:"wall",".":"stone","-":"wood","+":"tiles",";":"carpet","[":"table"},ye="[c",fe={"[":"table",c:"chair"},xe=";[",we={P:ie.pistol,G:ie.mg,M:ie.minigun};let ve,be,Me=null;async function Se(e,t){const s=await async function(e){const t=await fetch(`levels/${e}.txt`,{});return await t.text()}(t),[i,o,a]=s.split("#"),r=a.split("\n").map(e=>Array.from(e)),h=new Map;for(const e of o.split("\n"))h.set(e[0],Array.from(e.slice(1)));let l=0;for(let t=0;t<r.length;t++){const s=r[t];for(let i=0;i<s.length;i++){l=Math.max(l,s.length);const n=s[i];if(h.has(n)){const o=h.get(n);for(const s of o)Te(e,r,i,t,s);s[i]=o[o.length-1]}else Te(e,r,i,t,n);xe.includes(n)&&ke(e,r,i,t)}}e.worldHeight=r.length*n,e.worldWidth=l*n,e.level=r;const c=i.trim();for(const t of c){const s=e.getSystem(U),i=new ne(e,we[t]);s.player.agent.addWeapon(i,.5)}}function Te(e,t,s,o,a){const r=e.getSystem(de),h=new i(s*n,o*n);if("{"===a)return Me="",be=h,void new C(e,{pos:h,sprite:me[ve]});if(null!==Me)return new C(e,{pos:h,sprite:me[ve]}),void("}"===a?(new C(e,{pos:be.copy(),text:Me}),Me=null):Me+=a);if(" "!==a){if(ve=a,"X"===a?new X(e,{pos:h}):ye.includes(a)?new X(e,{pos:h,colisionMask:M,sprite:fe[a],zIndex:1}):ue.includes(a)&&new C(e,{pos:h,sprite:me[a]}),"X"!==a&&!ue.includes(a)){const i=function(e,t,s){const i=new Map;for(const[n,o,a]of Pe(e,t,s))if(ue.includes(a)){const e=(i.get(a)||0)+1;i.set(a,e)}let n,o=0;for(const[e,t]of i.entries())t>o&&(o=t,n=e);return n}(t,s,o);i&&new C(e,{pos:h.copy(),sprite:me[i]})}if("S"===a)new $(e,Object.create(h));else if("z"===a)new ce(e,{pos:Object.create(h)});else if("E"===a)new ce(e,{pos:Object.create(h),weapon:"mg"});else if("e"===a)new ce(e,{pos:Object.create(h),weapon:"pistol"});else if("a"===a)new ce(e,{pos:Object.create(h),weapon:"pistol",superAggresive:!0});else if("A"===a)new ce(e,{pos:Object.create(h),weapon:"mg",superAggresive:!0});else if("m"===a)new ce(e,{pos:Object.create(h),weapon:"minigun",maxHealth:10});else if("M"===a)new ce(e,{pos:Object.create(h),weapon:"minigun",maxHealth:40,canBeAssasinated:!1,superAggresive:!0});else if("P"===a)new ce(e,{pos:Object.create(h),canPatrol:!0,weapon:"pistol"});else if("D"===a)new ce(e,{pos:Object.create(h),canPatrol:!0,weapon:"mg"});else if("B"===a){const i=Ae(t,s,o);new Z(e,{pos:h,broken:!0,physical:!0,wallDirection:i,radius:125})}else if("L"===a||"l"===a){const i=Ae(t,s,o);new Z(e,{pos:h,physical:!0,wallDirection:i,radius:"L"===a?250:125})}else"H"===a?new Z(e,{pos:h,physical:!1}):"l"===a?new Z(e,{pos:h}):"_"===a?new ge(e,{pos:h,orientation:le.horizontal}):"|"===a?new ge(e,{pos:h,orientation:le.vertical}):"p"===a&&r.addPatrolPoint(h)}}function*Pe(e,t,s){let[i,n]=[Math.max(t-1,0),s];yield[i,n,e[n][i]],[i,n]=[t+1,s],yield[i,n,e[n][i]],[i,n]=[t,Math.max(s-1,0)],yield[i,n,e[n][i]],[i,n]=[t,s+1],yield[i,n,e[n][i]]}function Ae(e,t,s){return"X"===e[s][Math.max(t-1,0)]?"left":"X"===e[Math.max(s-1,0)][t]?"up":"X"===e[s][t+1]?"right":"down"}function ke(e,t,s,o){const r=new i(s*n,o*n),h=t[o][s],l=me[h]+"Border",c=a[l];for(const[a,d,g]of Pe(t,s,o))if(g!==h&&"X"!==g){const t=new i(a*n,d*n),h=t.directionTo(r);a<s?(t.x+=n-c.h,t.y+=n):a>s?t.x+=c.h:d>o?(t.x+=n,t.y+=c.h):d<o&&(t.y+=n-c.h),new C(e,{pos:t,rot:h,zIndex:1,sprite:l})}}class Ce{constructor(e,t,s={}){this.renderer=t,this.canvas=null,this.followPlayer=!0,this.fill=null,this.renderWholeWorld=!1,this.clear=!0,Object.assign(this,s),t.compositor.layers[e]=this,this.canvas||(this.canvas=document.createElement("canvas")),this.context=this.canvas.getContext("2d")}init(){this.updateSize(),this.clearCanvas()}updateSize(e=!0){this.renderWholeWorld?e&&(this.canvas.width=this.renderer.game.engine.worldWidth,this.canvas.height=this.renderer.game.engine.worldHeight):(this.canvas.width=this.renderer.game.canvas.width,this.canvas.height=this.renderer.game.canvas.height)}clearCanvas(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}activate(){this.renderer.activeLayer&&this.renderer.activeLayer.context.restore(),this.renderer.activeLayer=this,this.renderer.context=this.context,this.clear&&this.clearCanvas(),this.fill&&(this.context.fillStyle=this.fill,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)),this.followPlayer&&(this.context.save(),this.context.translate(this.renderer.game.camera.pos.x,this.renderer.game.camera.pos.y))}}function Re(e,t,s,n,o,a){const r=[];for(let e=-o/2;e<o/2;e+=Math.PI/100){const o=new i(0,a).rotate(n+e).add(s);r.push(t.castRay(s,o)||o)}e.beginPath(),e.moveTo(r[0].x,r[0].y);for(let t=1;t<r.length;t++){const s=r[t];e.lineTo(s.x,s.y)}o!==2*Math.PI&&e.lineTo(s.x,s.y),e.closePath(),e.fill()}class Ie{constructor(e){this.renderer=e,this.flashlightPrerenderLayer=new Ce("",this.renderer),this.staticLightsLayer=new Ce("staticLights",this.renderer,{renderWholeWorld:!0,followPlayer:!1}),this.flashlightLayer=new Ce("flashlight",this.renderer),this.combinedLightsLayer=new Ce("combinedLights",this.renderer,{fill:"black"}),this.propsLayer=new Ce("props",this.renderer,{renderWholeWorld:!0,followPlayer:!1,clear:!1}),this.higherPropsLayer=new Ce("higherProps",this.renderer,{renderWholeWorld:!0,followPlayer:!1,clear:!1}),this.movingPropsLayer=new Ce("movingProps",this.renderer),this.particlesLayer=new Ce("particles",this.renderer),this.bloodLayer=new Ce("blood",this.renderer,{renderWholeWorld:!0,followPlayer:!1,clear:!1})}get context(){return this.renderer.context}get engine(){return this.renderer.game.engine}renderLowerProps(){const e=this.engine.getSystem(R);for(const t of e.zIndexes)this.renderProps(e.toRender[t]),e.toRender[t]=[]}renderHigherProps(){const e=this.engine.getSystem(R);this.renderProps(e.higherToRender),e.higherToRender=[]}renderChangingProps(){const e=this.engine.getSystem(R);this.renderProps(e.entities)}renderProps(e){for(const t of e){const e=null!==t.rot,s=a[t.sprite];if(e){this.context.save();const e=t.pivot.copy().rotate(t.rot);this.context.translate(t.pos.x-e.x+t.offset.x,t.pos.y-e.y+t.offset.y),this.context.rotate(t.rot)}this.context.drawImage(this.renderer.texture,s.x,s.y,s.w,s.h,e?0:t.pos.x,e?0:t.pos.y,s.w,s.h),e&&this.context.restore()}}renderCharProps(){this.context.font="16px sans-serif",this.context.fillStyle="white",this.context.textBaseline="top";const e=this.engine.getSystem(R);for(const t of e.charsToRender)this.context.fillText(t.text,t.pos.x,t.pos.y);e.charsToRender=[]}renderAgents(){const e=a.body,t=a.armsFree,s=a.armsGrabbing,i=a.armsFisting;this.context.globalCompositeOperation="source-over";for(const o of this.engine.getSystem(j).entities){let r;if(r=o.isFisting?i:o.currentWeapon?s:t,this.context.save(),this.context.translate(o.posAndVel.pos.x,o.posAndVel.pos.y),this.context.save(),this.context.rotate(o.rot),this.context.drawImage(this.renderer.texture,e.x,e.y,e.w,e.h,-n/2+2,-n/2+3,e.w,e.h),this.context.drawImage(this.renderer.texture,r.x,r.y,r.w,r.h,-n/2+2,-n/2+10,r.w,r.h),o.currentWeapon){const e=a[`gun${o.currentWeapon.options.code}`];this.context.drawImage(this.renderer.texture,e.x,e.y,e.w,e.h,-3,8,e.w,e.h)}this.context.restore(),this.context.fillStyle="red";const h=n/o.maxHealth*o.health;this.context.fillRect(-n/2,n/2+5,h,1),this.context.restore()}}renderParticles(){this.context.globalCompositeOperation="source-over";const e=this.engine.getSystem(O);for(const t of Object.keys(e.byColors)){this.context.strokeStyle=t;for(const s of e.byColors[t]){const e=s.posAndVel.pos,t=s.posAndVel.vel;this.context.beginPath(),this.context.moveTo(e.x,e.y),this.context.lineTo(e.x+t.x,e.y+t.y),this.context.stroke()}}}renderLights(){const e=this.engine.getSystem(ee);if(e.needRerender){e.needRerender=!1,this.staticLightsLayer.activate(),this.context.globalCompositeOperation="lighten";for(const t of e.entities)if(t.enabled){const e=t.radius;let s;this.context.save(),this.context.translate(t.pos.x,t.pos.y),t.physical?(this.context.rotate(t.direction.angle()),s=this.context.createRadialGradient(0,0,0,0,e/2,e/2)):s=this.context.createRadialGradient(0,0,0,0,0,e/2),s.addColorStop(0,t.power),s.addColorStop(1,"transparent"),this.context.fillStyle=s,t.physical?this.context.fillRect(-e/2,0,e,e):this.context.fillRect(-e/2,-e/2,e,e),this.context.restore()}this.context.globalCompositeOperation="source-over"}}renderBlood(){const e=this.engine.getSystem(W);this.context.strokeStyle="red",this.context.lineWidth=1;for(const t of e.toRender)this.context.beginPath(),this.context.moveTo(t.from.x,t.from.y),this.context.lineTo(t.to.x,t.to.y),this.context.stroke();this.context.fillStyle="red";for(const t of e.leaksToRender)this.context.beginPath(),this.context.arc(t.pos.x,t.pos.y,t.size,0,2*Math.PI),this.context.fill();e.toRender=[],e.leaksToRender=[]}renderFlashlights(){this.context.globalCompositeOperation="lighten";const e=this.engine.getSystem(E),t=this.engine.getSystem(k);for(const s of e.entities){const e=s.agent.posAndVel.pos,i=s.agent.rot,n=this.context.createRadialGradient(e.x,e.y,20,e.x,e.y,120);n.addColorStop(0,"#ddd"),n.addColorStop(1,"transparent"),this.context.fillStyle=n,Re(this.context,t,e,i,Math.PI/2,120)}}render(){this.renderLights(),this.propsLayer.activate(),this.renderLowerProps(),this.renderCharProps(),this.movingPropsLayer.activate(),this.renderAgents(),this.renderChangingProps(),this.bloodLayer.activate(),this.renderBlood(),this.higherPropsLayer.activate(),this.renderHigherProps(),this.particlesLayer.activate(),this.renderParticles(),this.flashlightLayer.activate(),this.renderFlashlights(),this.combinedLightsLayer.activate()}}const Oe="\nattribute vec4 pos;\nvarying highp vec2 uv;\n\nvoid main() {\n  gl_Position = pos;\n  uv = vec2(pos.x / 2.0 + 0.5, -pos.y / 2.0 + 0.5);\n}",Le="\nprecision mediump float;\nvarying highp vec2 uv;\nuniform sampler2D u_texture;\n\nconst float colors = 16.0;\nfloat limit(float x) {\n  return floor(x * 255.0 / colors) / colors;\n}\n\nvoid main(void) {\n  vec4 c = texture2D(u_texture, uv);\n  float r = limit(c.r);\n  float g = limit(c.g);\n  if (r != g) {\n    g = 0.0;\n  }\n  gl_FragColor = vec4(r, g, g, 1.0);\n}",We=new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]);class Ve{constructor(e){this.canvas=e,this.gl=e.getContext("webgl"),this.updateViewport();const t=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(t,Le),this.gl.compileShader(t);const s=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(s,Oe),this.gl.compileShader(s);const i=this.gl.createProgram();this.gl.attachShader(i,s),this.gl.attachShader(i,t),this.gl.linkProgram(i),this.gl.useProgram(i);const n=this.gl.getAttribLocation(i,"pos"),o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,We,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(n);const a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE)}postprocess(e){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e.canvas),this.gl.drawArrays(this.gl.TRIANGLES,0,We.length/2)}updateViewport(){this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}}class Ee{constructor(e){this.renderer=e,this.revealedMaskLayer=new Ce("revealedMask",this.renderer,{renderWholeWorld:!0,followPlayer:!1,clear:!1}),this.visibilityMaskLayer=new Ce("visibilityMask",this.renderer),this.fogOfWarLayer=new Ce("fogOfWar",this.renderer,{fill:"#aaa",followPlayer:!1})}get context(){return this.renderer.context}get engine(){return this.renderer.game.engine}get canvas(){return this.renderer.game.canvas}get camera(){return this.renderer.game.camera}render(){const e=this.engine.getSystem(k),t=this.engine.getSystem(U);if(!t.player)return;this.visibilityMaskLayer.activate();const s=t.player.agent.posAndVel.pos,i=Math.sqrt(Math.pow(this.canvas.width,2)+Math.pow(this.canvas.height,2));this.context.fillStyle="white",Re(this.context,e,s,0,2*Math.PI,i),this.revealedMaskLayer.context.drawImage(this.visibilityMaskLayer.canvas,0,0,this.canvas.width,this.canvas.height,-this.camera.pos.x,-this.camera.pos.y,this.canvas.width,this.canvas.height),this.fogOfWarLayer.activate(),this.context.drawImage(this.visibilityMaskLayer.canvas,0,0)}}const Be=1500;class De{constructor(e){this.game=e,this.interfaceLayer=new Ce("interface",this.game.renderer,{followPlayer:!1,clear:!0})}get context(){return this.game.renderer.context}get engine(){return this.game.engine}get canvas(){return this.game.canvas}render(){this.interfaceLayer.activate(),this.context.textBaseline="top",this.context.shadowColor="black",this.context.shadowBlur=4,this.game.paused?this.renderMenu():this.renderGameGui()}renderMenu(){this.context.fillStyle="rgba(0, 0, 0, 0.5)",this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.drawBloodyText("Shutter Asylum",26,20),this.context.fillStyle="white",this.context.font="15px sans-serif";const e=this.game.mainMenu.menu;let t=60;for(const s of e.activeMenu.options){let i;i="string"==typeof s.text?s.text:s.text(),this.drawTextCentered(i,15,t);const n=this.context.measureText(i).width,o=(this.canvas.width-n)/2;this.context.fillText(i,o,t),e.selectedOption===s&&(this.context.beginPath(),this.context.arc(o-10,t+8,5,0,2*Math.PI),this.context.fill()),t+=20}this.context.fillStyle="grey";for(const s of e.activeMenu.staticOptions)this.drawTextCentered(s,15,t),t+=20}renderGameGui(){const e=this.engine.getSystem(U).entities[0];this.context.fillStyle="white";let t=50;if(this.game.stageCompleted){const e=(this.game.levelFinishDuration/1e3).toFixed(1);this.drawTextCentered(`STAGE CLEARED in ${e}s`,20,t),this.game.newBestTime&&this.drawTextCentered("New best time!",18,t+=20),this.game.gameCompleted||this.drawTextCentered("Press <enter> to proceed",14,t+=20)}if(this.game.gameCompleted&&(this.drawTextCentered("THAT'S ALL",20,t+=40),this.drawTextCentered("This was the last level",14,t+=20),this.drawTextCentered("Try harder difficulty for more challenges",14,t+=20)),this.context.font="12px sans-serif",e?(this.renderPlayerContext(e),this.renderBottomBar(e)):this.game.isLoading||(this.drawBloodyText("YOU DIED",26,t+=20),this.game.stageCompleted||this.drawTextCentered("Press <enter> to try again",14,t+=40)),this.game.notification){const e=this.engine.time-this.game.notification.timestamp,t=e/Be,s=22;this.context.fillStyle=`rgba(255, 255, 255, ${1-t})`,this.drawTextCentered(this.game.notification.text,s,185-s),e>Be&&(this.game.notification=null)}}renderPlayerContext(e){const t=this.engine.getSystem(Y).action,s=e.agent.currentWeapon;let i="",n=-8;s&&s.reloading&&(this.drawContextIcon("reload",n),n+=8),e.agent.isRunning||(e.isVisible?this.drawContextIcon("visible",n):this.drawContextIcon("hidden",n)),t&&(i+=`${t.text} (E)`);const o=this.context.measureText(i).width;this.context.fillText(i,this.canvas.width/2-o/2,this.canvas.height/2+20)}renderBottomBar(e){const t=e.agent.currentWeapon,s=this.canvas.height-20;if(t){const e=`${t.options.name} ${t.bulletsInMagazine} / ${t.options.magazineCapacity} (${t.totalBullets})`;this.context.fillText(e,10,s)}else this.context.fillText("NO WEAPON",10,s)}drawContextIcon(e,t){const s=a[e];this.context.drawImage(this.game.renderer.texture,s.x,s.y,s.w,s.h,this.canvas.width/2+t,this.canvas.height/2+18,s.w,s.h)}drawTextCentered(e,t,s){this.context.font=`${t}px sans-serif`;const i=this.context.measureText(e).width,n=this.game.canvas.width/2-i/2;return this.context.fillText(e,n,s),[n,i]}drawBloodyText(e,t,s){this.context.font=`${t}px sans-serif`,this.context.fillStyle="red",this.drawTextCentered(e,t,s),this.context.fillStyle="white"}}const He=[{target:"movingProps",source:"visibilityMask",blendMode:"destination-in"},{target:"particles"},{target:"flashlight"},{target:"combinedLights",source:"flashlight",blendMode:"screen",offset:!1},{target:"combinedLights",source:"staticLights",blendMode:"screen",offset:!0},{target:"base",source:"props",blendMode:"source-over",offset:!0},{source:"blood",blendMode:"multiply"},{source:"higherProps",blendMode:"source-over"},{source:"movingProps",offset:!1},{source:"combinedLights",blendMode:"overlay",offset:!1},{source:"particles",blendMode:"source-over",offset:!1},{source:"fogOfWar",blendMode:"multiply"},{source:"revealedMask",blendMode:"destination-in",offset:!0},{source:"interface",blendMode:"source-over",offset:!1}];class je{constructor(e){this.renderer=e,this.layers={}}get camera(){return this.renderer.game.camera}get canvas(){return this.renderer.game.canvas}init(){for(const e of Object.values(this.layers))e.init()}compose(){const e={};for(const t of He){"base"===t.target&&this.layers.base.activate(),Object.assign(e,t);const s=this.layers[e.target],i=this.layers[e.source];s.context.globalCompositeOperation=e.blendMode,!0===e.offset?this.drawLayerWithCameraOffset(s,i):s.context.drawImage(i.canvas,0,0)}}drawLayerWithCameraOffset(e,t){e.context.drawImage(t.canvas,-this.camera.pos.x,-this.camera.pos.y,this.canvas.width,this.canvas.height,0,0,this.canvas.width,this.canvas.height)}}class qe{constructor(e){this.game=e,this.ready=!1,this.texture=new Image,this.texture.src="tex.png",this.texture.onload=(()=>this.ready=!0)}render(){this.ready&&(this.systemsRenderer.render(),this.fogOfWar.render(),this.guiRenderer.render(),this.compositor.compose(),this.postprocessing.postprocess(this.baseLayer))}init(){this.compositor=new je(this),this.postprocessing=new Ve(this.game.canvas),this.guiRenderer=new De(this.game),this.systemsRenderer=new Ie(this),this.fogOfWar=new Ee(this),this.baseLayer=new Ce("base",this,{followPlayer:!1,fill:"black"}),this.compositor.init()}checkDistinctColors(){this.checkColorsLayer.context.drawImage(this.game.canvas,0,0,this.game.canvas.width,this.game.canvas.height);const e=this.checkColorsLayer.context.getImageData(0,0,this.game.canvas.width,this.game.canvas.height).data,t=new Set;for(let s=0;s<e.length;s+=4){const i=`${e[s]},${e[s+1]},${e[s+2]}`;t.add(i)}const s=`Number of colors: ${t.size}`;t.size>32?console.error(s):console.log(s)}updateSize(){if(this.game.canvas.width=Math.floor(window.innerWidth/3),this.game.canvas.height=Math.floor(window.innerHeight/3),this.compositor)for(const e of Object.values(this.compositor.layers))e.updateSize(!1);this.postprocessing&&this.postprocessing.updateViewport()}}class Ge{constructor(e){this.game=e,this.keys=new Map,this.mouseButtons=new Map,this.mousePos=new i,this.rot=0}init(){window.addEventListener("keydown",e=>{const t=this.game.engine.getSystem(U);if(this.keys.set(e.code,!0),"Escape"===e.key?this.game.isStarted&&(this.game.paused=!this.game.paused,this.game.mainMenu.menu.active=this.game.paused,this.game.mainMenu.menu.activeMenu.backToParent()):"KeyC"===e.code||"Shift"===e.key?t.player&&t.player.agent.toggleWalkRun():"Enter"!==e.key||this.game.paused?"z"===e.key&&this.game.engine.sound.play("emptyMagazine"):this.game.stageCompleted?this.game.loadNextLevel():this.game.isPlayerDead&&this.game.restartLevel(),this.game.mainMenu.menu.active&&("KeyW"===e.code||"ArrowUp"===e.key?this.game.mainMenu.menu.movePointer(-1):"KeyS"===e.code||"ArrowDown"===e.key?this.game.mainMenu.menu.movePointer(1):"Enter"!==e.key&&" "!==e.key&&"KeyE"!==e.code||this.game.mainMenu.menu.select()),!this.game.paused){const t=this.game.engine.getSystem(U),s=this.game.engine.getSystem(Y);if(!t.player)return;"KeyQ"===e.code?t.player.agent.nextWeapon():"KeyR"===e.code?t.player.agent.currentWeapon&&t.player.agent.currentWeapon.reload():"KeyE"===e.code?s.action&&s.action.trigger():"KeyF"===e.code&&t.player.agent.toggleFlashlight()}}),window.addEventListener("keyup",e=>{const t=this.game.engine.getSystem(U);this.keys.set(e.code,!1),"Shift"===e.key&&t.player&&t.player.agent.toggleWalkRun()}),window.addEventListener("mousemove",e=>{this.mousePos.x=Math.round(this.game.canvas.width*e.clientX/window.innerWidth),this.mousePos.y=Math.round(this.game.canvas.height*e.clientY/window.innerHeight),this.rot=Math.atan2(this.game.canvas.height/2-this.mousePos.y,this.game.canvas.width/2-this.mousePos.x)+Math.PI/2}),window.addEventListener("mousedown",e=>{if(this.game.paused)return;const t=this.game.engine.getSystem(U);this.mouseButtons.set(e.button,!0),1===e.button&&t.player&&t.player.agent.toggleFlashlight()}),window.addEventListener("mouseup",e=>{this.mouseButtons.set(e.button,!1)})}}class Fe{constructor(e){this.canvas=e,this.pos=new i}connectWithAgent(e){this.agent=e}update(){this.pos.x=-this.agent.posAndVel.pos.x+this.canvas.width/2,this.pos.y=-this.agent.posAndVel.pos.y+this.canvas.height/2,this.pos.quantify()}}class ze{constructor(){this.active=!1,this.pointer=0,this.options=[],this.staticOptions=[],this.activeMenu=this}addOption(e){this.options.push(e)}addStaticOption(e){this.staticOptions.push(e)}movePointer(e){this.activeMenu.pointer+=e,this.activeMenu.pointer<0?this.activeMenu.pointer=this.activeMenu.options.length-1:this.activeMenu.pointer>=this.activeMenu.options.length&&(this.activeMenu.pointer=0)}select(){this.activeMenu.selectedOption.callback()}get selectedOption(){return this.activeMenu.options[this.activeMenu.pointer]}addSubmenu(e,t){t.parentMenu=this,this.options.push({text:e,callback:()=>this.activeMenu=t})}clear(){this.pointer=0,this.options=[],this.staticOptions=[]}backToParent(){this.parentMenu&&(this.parentMenu.activeMenu=this.parentMenu)}}class _e{constructor(e){this.game=e,this.menu=new ze,this.levelsMenu=new ze,this.controlsMenu=new ze,this.objectiveMenu=new ze,this.menu.addOption({text:"Start new game",callback:()=>this.game.start(1)}),this.menu.addSubmenu("Levels selection",this.levelsMenu),this.menu.addOption({text:()=>`Difficulty: ${F.name}`,callback:()=>{!function(){switch(F.name){case"easy":F=G.normal;break;case"normal":F=G.hard;break;case"hard":F=G.easy}localStorage.setItem(q,F.name)}(),this.updateLevelsList(),this.menu.active=!0}}),this.menu.addSubmenu("Show controls",this.controlsMenu),this.controlsMenu.addOption({text:"Back",callback:()=>this.levelsMenu.backToParent()}),this.controlsMenu.addStaticOption("WASD - movement"),this.controlsMenu.addStaticOption("mouse - aiming"),this.controlsMenu.addStaticOption("SPACE, LMB - shooting"),this.controlsMenu.addStaticOption("F, MMB - flashlight"),this.controlsMenu.addStaticOption("Q - change weapon"),this.controlsMenu.addStaticOption("E - use"),this.controlsMenu.addStaticOption("C - toggle sneak/run"),this.controlsMenu.addStaticOption("SHIFT - sneak/run"),this.controlsMenu.addStaticOption("ESC - toggle pause and menu"),this.menu.addSubmenu("Game objective",this.objectiveMenu),this.objectiveMenu.addOption({text:"Back",callback:()=>this.objectiveMenu.backToParent()}),this.objectiveMenu.addStaticOption("Fight your way back to home through the"),this.objectiveMenu.addStaticOption("Shutter Asylum."),this.objectiveMenu.addStaticOption("The game's main objective is to kill"),this.objectiveMenu.addStaticOption("each enemy in every stage."),this.objectiveMenu.addStaticOption("Additional objective is to speed run"),this.objectiveMenu.addStaticOption("each level, best times are recorded."),this.objectiveMenu.addStaticOption("Use stealth, you won't survive on"),this.objectiveMenu.addStaticOption("higher difficulties by being Rambo."),this.updateLevelsList()}updateLevelsList(){const e=Math.min(o,Object.keys(this.game.scores[F.name]).length+1);this.levelsMenu.clear(),this.levelsMenu.addOption({text:"Back",callback:()=>this.levelsMenu.backToParent()});for(let t=1;t<=e;t++)this.levelsMenu.addOption({text:()=>{let e=this.game.scores[F.name][t],s=`level ${t}`;return e&&(s+=` (best time: ${(e/1e3).toFixed(1)}s)`),s},callback:()=>this.game.start(t)});for(let t=e+1;t<=o;t++)this.levelsMenu.addStaticOption(`level ${t}`)}}const Ne="scores";class $e{constructor(e){this.canvas=e,this.paused=!0,this.stageCompleted=!1,this.gameCompleted=!1,this.isPlayerDead=!1,this.isLoading=!0,this.isStarted=!1,this.newBestTime=!1,this.engine=new u(this),this.camera=new Fe(this.canvas),this.control=new Ge(this),this.renderer=new qe(this),this.renderer.updateSize(),this.control.init(),this.scores=JSON.parse(localStorage.getItem(Ne)),this.scores||(this.scores={easy:{},normal:{},hard:{}}),this.mainMenu=new _e(this),this.engine.worldWidth=1,this.engine.worldHeight=1,this.start(null),this.paused=!0,this.mainMenu.menu.active=!0}async start(e){this.currentLevel=e,this.stageCompleted=!1,this.gameCompleted=!1,this.newBestTime=!1,this.isLoading=!0,this.notification=null,this.isPlayerDead=!1,this.engine.clear();const t=new U;this.engine.register(new R),this.engine.register(new Q),this.engine.register(new j),this.engine.register(t),this.engine.register(new x),this.engine.register(new se),this.engine.register(new k),this.engine.register(new de),this.engine.register(new ee),this.engine.register(new O),this.engine.register(new W),this.engine.register(new Y),this.engine.register(new pe),this.engine.register(new E),this.engine.register(new D),this.engine.init(),e&&(await Se(this.engine,`level${e}`),this.camera.connectWithAgent(t.player.agent),this.isStarted=!0),this.renderer.init(),this.isLoading=!1,this.paused=!1,this.mainMenu.menu.active=!1}checkWinConditions(){const e=this.engine.getSystem(de);if(!this.stageCompleted&&!this.isLoading&&0===e.entities.length){this.stageCompleted=!0,this.levelFinishDuration=this.engine.time;const e=this.scores[F.name][this.currentLevel];(!e||this.levelFinishDuration<e)&&(this.newBestTime=!0),this.saveScore(),this.currentLevel===o&&(this.gameCompleted=!0)}}loadNextLevel(){this.gameCompleted||(this.currentLevel++,this.start(this.currentLevel))}restartLevel(){this.start(this.currentLevel)}saveScore(){this.scores[F.name][this.currentLevel]=this.levelFinishDuration,localStorage.setItem(Ne,JSON.stringify(this.scores)),this.mainMenu.updateLevelsList()}notifyNewWeapon(e){this.notification={text:e.options.name,timestamp:this.engine.time}}}let Ue=0;const Xe=1e3/60;let Qe;function Ke(e){const t=e-Ue,s=Math.floor(t/Xe);if(Ue+=s*Xe,!Qe.paused){Qe.checkWinConditions();for(let e=0;e<s;e++)Qe.engine.update(Xe);Qe.camera.update()}Qe.renderer.render(),requestAnimationFrame(Ke)}!function(){const e=document.getElementsByTagName("canvas")[0];Qe=new $e(e),requestAnimationFrame(Ke),window.addEventListener("visibilitychange",()=>{Qe.paused=!0,Qe.mainMenu.menu.active=!0}),window.addEventListener("resize",()=>Qe.renderer.updateSize())}()}]);